<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gest√£o de Infraestrutura</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background-color: #f4f4f4; }
    h1, h2 { text-align: center; }
    form, .section { background-color: #fff; padding: 20px; margin-bottom: 30px; border: 1px solid #ccc; }
    input, select, textarea { margin: 10px 0; padding: 8px; width: 100%; box-sizing: border-box; }
    button { padding: 10px 20px; background-color: #007BFF; color: white; border: none; cursor: pointer; margin: 5px; }
    table { width: 100%; border-collapse: collapse; background-color: #fff; margin-bottom: 40px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background-color: #007BFF; color: white; }
    .hidden { display: none; }
    .done { background-color: #d4edda !important; }
    .filter-bar { margin-bottom: 15px; background: #e3e8f0; padding: 12px; border-radius: 6px; }
    .expand-btn { font-size: 20px; font-weight: bold; padding: 0 10px; background: none; border: none; cursor: pointer; color: #007BFF; }
    .checklist-row { background: #f9f9f9; }
    .checklist-list { margin: 0; padding: 5px 0 0 30px; }
    .checklist-list li { list-style: none; margin: 6px 0; display: flex; align-items: center; }
    .checklist-checkbox { margin-right: 8px; }
  </style>
</head>
<body>
  <h1>Gest√£o de Infraestrutura</h1>
  <div>
    <button onclick="mostrarSecao('clientes')">Clientes</button>
    <button onclick="mostrarSecao('tecnicos')">T√©cnicos</button>
    <button onclick="mostrarSecao('tipos')">Tipos de Tarefa</button>
    <button onclick="mostrarSecao('tarefas')">Tarefas</button>
  </div>

  <!-- CLIENTES -->
  <div id="secao-clientes" class="section hidden">
    <h2>Clientes</h2>
    <button onclick="mostrarSecao('menu')">Menu</button>
    <form id="clienteForm">
      <input type="text" id="razaoSocial" placeholder="Raz√£o Social" required>
      <input type="text" id="cnpj" placeholder="CNPJ" required>
      <input type="text" id="telefone" placeholder="Telefone" required>
      <input type="email" id="email" placeholder="E-mail" required>
      <button type="submit">Adicionar Cliente</button>
    </form>
    <table id="tabelaClientes">
      <thead>
        <tr>
          <th>Raz√£o Social</th><th>CNPJ</th><th>Telefone</th><th>Email</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- T√âCNICOS -->
  <div id="secao-tecnicos" class="section hidden">
    <h2>T√©cnicos</h2>
    <button onclick="mostrarSecao('menu')">Menu</button>
    <form id="tecnicoForm">
      <input type="text" id="nomeTecnico" placeholder="Nome" required>
      <input type="text" id="funcaoTecnico" placeholder="Fun√ß√£o" required>
      <input type="text" id="telefoneTecnico" placeholder="Telefone" required>
      <input type="email" id="emailTecnico" placeholder="E-mail" required>
      <button type="submit">Adicionar T√©cnico</button>
    </form>
    <table id="tabelaTecnicos">
      <thead>
        <tr>
          <th>Nome</th><th>Fun√ß√£o</th><th>Telefone</th><th>Email</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- TIPOS DE TAREFA -->
  <div id="secao-tipos" class="section hidden">
    <h2>Tipos de Tarefa</h2>
    <button onclick="mostrarSecao('menu')">Menu</button>
    <form id="tipoForm">
      <input type="text" id="nomeTipo" placeholder="Nome do Tipo" required>
      <textarea id="checklistTipo" placeholder="Checklist, um por linha"></textarea>
      <button type="submit">Adicionar Tipo</button>
    </form>
    <table id="tabelaTipos">
      <thead>
        <tr>
          <th>Tipo</th><th>Checklist</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- TAREFAS -->
  <div id="secao-tarefas" class="section hidden">
    <h2>Tarefas</h2>
    <button onclick="mostrarSecao('menu')">Menu</button>
    <form id="tarefaForm">
      <input type="text" id="tituloTarefa" placeholder="T√≠tulo da Tarefa" required>
      <select id="clienteTarefa" required>
        <option value="">Selecione o Cliente</option>
      </select>
      <select id="tecnicoTarefa" required>
        <option value="">Selecione o T√©cnico</option>
      </select>
      <select id="tipoTarefa" required onchange="renderPreviewChecklist()">
        <option value="">Selecione o Tipo de Tarefa</option>
      </select>
      <input type="date" id="dataTarefa" required>
      <div id="preview-checklist" class="hidden">
        <b>Checklist:</b>
        <ul id="previewChecklistList"></ul>
      </div>
      <button type="submit">Adicionar Tarefa</button>
    </form>

    <div class="filter-bar">
      <label>Cliente:</label>
      <select id="filtroCliente" onchange="renderTarefas()">
        <option value="">Todos</option>
      </select>
      <label>T√©cnico:</label>
      <select id="filtroTecnico" onchange="renderTarefas()">
        <option value="">Todos</option>
      </select>
      <label>Tipo:</label>
      <select id="filtroTipo" onchange="renderTarefas()">
        <option value="">Todos</option>
      </select>
      <label>Status:</label>
      <select id="filtroStatus" onchange="renderTarefas()">
        <option value="">Todos</option>
        <option value="pendente">Pendente</option>
        <option value="concluida">Conclu√≠da</option>
      </select>
      <label>Data:</label>
      <input type="date" id="filtroData" onchange="renderTarefas()">
      <button onclick="limparFiltros();return false;">Limpar Filtros</button>
    </div>

    <button onclick="exportarTarefasPDF()">Exportar PDF</button>
    <button onclick="exportarJSON()">Exportar JSON</button>
    <input type="file" id="importarJSONinput" style="display:none" accept=".json" onchange="importarJSON(this)">
    <button onclick="document.getElementById('importarJSONinput').click()">Importar JSON</button>

    <div id="tarefasContainer">
      <table id="tabelaTarefas">
        <thead>
          <tr>
            <th></th>
            <th>T√≠tulo</th>
            <th>Cliente</th>
            <th>T√©cnico</th>
            <th>Tipo</th>
            <th>Data</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
let clientes = [], tecnicos = [], tiposDeTarefa = {}, tarefas = [];
let expandedTarefa = {}; // indica se a tarefa est√° expandida

function salvarClientes() { localStorage.setItem('clientes', JSON.stringify(clientes)); }
function carregarClientes() { clientes = JSON.parse(localStorage.getItem('clientes')||'[]'); }
function renderClientes() {
  let tbody = document.getElementById('tabelaClientes').getElementsByTagName('tbody')[0];
  tbody.innerHTML = '';
  clientes.forEach((cli, i) => {
    let row = tbody.insertRow();
    row.insertCell(0).innerText = cli.razaoSocial;
    row.insertCell(1).innerText = cli.cnpj;
    row.insertCell(2).innerText = cli.telefone;
    row.insertCell(3).innerText = cli.email;
    let acoes = row.insertCell(4);
    let editar = document.createElement('button');editar.innerText = "‚úèÔ∏è";editar.onclick = () => editarCliente(i);
    let excluir = document.createElement('button');excluir.innerText = "üóëÔ∏è";excluir.onclick = () => { clientes.splice(i,1); salvarClientes(); renderClientes(); atualizarSelects(); renderTarefas(); };
    acoes.appendChild(editar); acoes.appendChild(excluir);
  });
  atualizarSelects();
}
function editarCliente(i) {
  let cli = clientes[i];
  document.getElementById('razaoSocial').value = cli.razaoSocial;
  document.getElementById('cnpj').value = cli.cnpj;
  document.getElementById('telefone').value = cli.telefone;
  document.getElementById('email').value = cli.email;
  let form = document.getElementById('clienteForm');
  form.editando = i;
  form.querySelector('button').innerText = "Salvar Altera√ß√£o";
}
document.getElementById('clienteForm').onsubmit = function(e) {
  e.preventDefault();
  let obj = {
    razaoSocial: document.getElementById('razaoSocial').value,
    cnpj: document.getElementById('cnpj').value,
    telefone: document.getElementById('telefone').value,
    email: document.getElementById('email').value
  };
  if(this.editando !== undefined) {
    clientes[this.editando] = obj;
    this.editando = undefined;
    this.querySelector('button').innerText = "Adicionar Cliente";
  } else {
    clientes.push(obj);
  }
  salvarClientes(); renderClientes(); this.reset();
};

function salvarTecnicos() { localStorage.setItem('tecnicos', JSON.stringify(tecnicos)); }
function carregarTecnicos() { tecnicos = JSON.parse(localStorage.getItem('tecnicos')||'[]'); }
function renderTecnicos() {
  let tbody = document.getElementById('tabelaTecnicos').getElementsByTagName('tbody')[0];
  tbody.innerHTML = '';
  tecnicos.forEach((tec, i) => {
    let row = tbody.insertRow();
    row.insertCell(0).innerText = tec.nome;
    row.insertCell(1).innerText = tec.funcao;
    row.insertCell(2).innerText = tec.telefone;
    row.insertCell(3).innerText = tec.email;
    let acoes = row.insertCell(4);
    let editar = document.createElement('button');editar.innerText = "‚úèÔ∏è";editar.onclick = () => editarTecnico(i);
    let excluir = document.createElement('button');excluir.innerText = "üóëÔ∏è";excluir.onclick = () => { tecnicos.splice(i,1); salvarTecnicos(); renderTecnicos(); atualizarSelects(); renderTarefas(); };
    acoes.appendChild(editar); acoes.appendChild(excluir);
  });
  atualizarSelects();
}
function editarTecnico(i) {
  let tec = tecnicos[i];
  document.getElementById('nomeTecnico').value = tec.nome;
  document.getElementById('funcaoTecnico').value = tec.funcao;
  document.getElementById('telefoneTecnico').value = tec.telefone;
  document.getElementById('emailTecnico').value = tec.email;
  let form = document.getElementById('tecnicoForm');
  form.editando = i;
  form.querySelector('button').innerText = "Salvar Altera√ß√£o";
}
document.getElementById('tecnicoForm').onsubmit = function(e) {
  e.preventDefault();
  let obj = {
    nome: document.getElementById('nomeTecnico').value,
    funcao: document.getElementById('funcaoTecnico').value,
    telefone: document.getElementById('telefoneTecnico').value,
    email: document.getElementById('emailTecnico').value
  };
  if(this.editando !== undefined) {
    tecnicos[this.editando] = obj;
    this.editando = undefined;
    this.querySelector('button').innerText = "Adicionar T√©cnico";
  } else {
    tecnicos.push(obj);
  }
  salvarTecnicos(); renderTecnicos(); this.reset();
};

function salvarTipos() { localStorage.setItem('tiposDeTarefa', JSON.stringify(tiposDeTarefa)); }
function carregarTipos() { tiposDeTarefa = JSON.parse(localStorage.getItem('tiposDeTarefa')||'{}'); }
function renderTipos() {
  let tbody = document.getElementById('tabelaTipos').getElementsByTagName('tbody')[0];
  tbody.innerHTML = '';
  Object.entries(tiposDeTarefa).forEach(([tipo, checklist], i) => {
    let row = tbody.insertRow();
    row.insertCell(0).innerText = tipo;
    row.insertCell(1).innerText = checklist.join(', ');
    let acoes = row.insertCell(2);
    let editar = document.createElement('button');editar.innerText = "‚úèÔ∏è";editar.onclick = () => editarTipo(tipo);
    let excluir = document.createElement('button');excluir.innerText = "üóëÔ∏è";excluir.onclick = () => { delete tiposDeTarefa[tipo]; salvarTipos(); renderTipos(); atualizarSelects(); renderTarefas(); };
    acoes.appendChild(editar); acoes.appendChild(excluir);
  });
  atualizarSelects();
}
function editarTipo(tipo) {
  document.getElementById('nomeTipo').value = tipo;
  document.getElementById('checklistTipo').value = (tiposDeTarefa[tipo]||[]).join('\n');
  let form = document.getElementById('tipoForm');
  form.editando = tipo;
  form.querySelector('button').innerText = "Salvar Altera√ß√£o";
}
document.getElementById('tipoForm').onsubmit = function(e) {
  e.preventDefault();
  let tipo = document.getElementById('nomeTipo').value;
  let checklist = document.getElementById('checklistTipo').value.split('\n').map(x=>x.trim()).filter(Boolean);
  tiposDeTarefa[tipo] = checklist;
  salvarTipos(); renderTipos(); this.reset();
  this.editando = undefined;
  this.querySelector('button').innerText = "Adicionar Tipo";
};

function salvarTarefas() { localStorage.setItem('tarefas', JSON.stringify(tarefas)); }
function carregarTarefas() { tarefas = JSON.parse(localStorage.getItem('tarefas')||'[]'); }
function renderPreviewChecklist() {
  let tipo = document.getElementById('tipoTarefa').value;
  let area = document.getElementById('preview-checklist');
  let ul = document.getElementById('previewChecklistList');
  ul.innerHTML = '';
  if(tiposDeTarefa[tipo]) {
    tiposDeTarefa[tipo].forEach(item => { let li = document.createElement('li'); li.innerText = item; ul.appendChild(li); });
    area.classList.remove('hidden');
  } else area.classList.add('hidden');
}
document.getElementById('tarefaForm').onsubmit = function(e) {
  e.preventDefault();
  let titulo = document.getElementById('tituloTarefa').value;
  let cliente = document.getElementById('clienteTarefa').value;
  let tecnico = document.getElementById('tecnicoTarefa').value;
  let tipo = document.getElementById('tipoTarefa').value;
  let data = document.getElementById('dataTarefa').value;
  let checklist = (tiposDeTarefa[tipo]||[]).map(texto=>({texto, feito:false}));
  if(this.editando !== undefined) {
    tarefas[this.editando] = {titulo, cliente, tecnico, tipo, data, status: "pendente", checklist};
    this.editando = undefined;
    this.querySelector('button').innerText = "Adicionar Tarefa";
  } else {
    tarefas.push({titulo, cliente, tecnico, tipo, data, status: "pendente", checklist});
  }
  salvarTarefas(); renderTarefas(); this.reset(); document.getElementById('preview-checklist').classList.add('hidden');
};

function renderTarefas() {
  let tbody = document.getElementById('tabelaTarefas').getElementsByTagName('tbody')[0];
  tbody.innerHTML = '';
  let fc = document.getElementById('filtroCliente').value;
  let ft = document.getElementById('filtroTecnico').value;
  let ftip = document.getElementById('filtroTipo').value;
  let fs = document.getElementById('filtroStatus').value;
  let fd = document.getElementById('filtroData').value;
  tarefas.forEach((tar, i) => {
    if(fc && tar.cliente!==fc) return;
    if(ft && tar.tecnico!==ft) return;
    if(ftip && tar.tipo!==ftip) return;
    if(fs && ((fs==='pendente' && tar.status!=='pendente')||(fs==='concluida'&&tar.status!=='concluida'))) return;
    if(fd && tar.data!==fd) return;

    // Linha principal da tarefa
    let row = tbody.insertRow();
    if(tar.status==="concluida") row.classList.add('done');

    // Bot√£o expandir/recolher
    let expandCell = row.insertCell(0);
    let expandBtn = document.createElement('button');
    expandBtn.type = "button";
    expandBtn.className = "expand-btn";
    expandBtn.innerText = expandedTarefa[i] ? "‚àí" : "+";
    expandBtn.title = expandedTarefa[i] ? "Recolher checklist" : "Expandir checklist";
    expandBtn.onclick = function() { expandedTarefa[i] = !expandedTarefa[i]; renderTarefas(); };
    expandCell.appendChild(expandBtn);

    row.insertCell(1).innerText = tar.titulo;
    row.insertCell(2).innerText = tar.cliente;
    row.insertCell(3).innerText = tar.tecnico;
    row.insertCell(4).innerText = tar.tipo;
    row.insertCell(5).innerText = tar.data;
    row.insertCell(6).innerText = tar.status==="concluida"?"Conclu√≠da":"Pendente";
    // A√ß√µes
    let acoes = row.insertCell(7);
    let concluir = document.createElement('button');
    concluir.innerText = "‚úÖ";
    concluir.disabled = tar.status==="concluida";
    concluir.onclick = () => { tar.checklist.forEach(x=>x.feito=true); tar.status="concluida"; salvarTarefas(); renderTarefas(); };
    let editar = document.createElement('button');
    editar.innerText = "‚úèÔ∏è";
    editar.onclick = () => editarTarefa(i);
    let excluir = document.createElement('button');
    excluir.innerText = "üóëÔ∏è";
    excluir.onclick = () => { tarefas.splice(i,1); delete expandedTarefa[i]; salvarTarefas(); renderTarefas(); };
    acoes.appendChild(concluir); acoes.appendChild(editar); acoes.appendChild(excluir);

    // Checklist expandido
    if(expandedTarefa[i]) {
      let clrow = tbody.insertRow();
      clrow.className = "checklist-row";
      let cell = clrow.insertCell(0);
      cell.colSpan = 8;
      let ul = document.createElement('ul');
      ul.className = "checklist-list";
      tar.checklist.forEach((item, idx) => {
        let li = document.createElement('li');
        let chk = document.createElement('input');
        chk.type = "checkbox";
        chk.className = "checklist-checkbox";
        chk.checked = item.feito;
        chk.onchange = function() {
          tar.checklist[idx].feito = this.checked;
          tar.status = tar.checklist.every(x=>x.feito) ? "concluida" : "pendente";
          salvarTarefas(); renderTarefas();
        };
        li.appendChild(chk);
        li.appendChild(document.createTextNode(item.texto));
        ul.appendChild(li);
      });
      cell.appendChild(ul);
    }
  });
}
function editarTarefa(i) {
  let tar = tarefas[i];
  document.getElementById('tituloTarefa').value = tar.titulo;
  document.getElementById('clienteTarefa').value = tar.cliente;
  document.getElementById('tecnicoTarefa').value = tar.tecnico;
  document.getElementById('tipoTarefa').value = tar.tipo;
  document.getElementById('dataTarefa').value = tar.data;
  renderPreviewChecklist();
  let form = document.getElementById('tarefaForm');
  form.editando = i;
  form.querySelector('button').innerText = "Salvar Altera√ß√£o";
}

function atualizarSelects() {
  function setOptions(sel, arr, valFn, textFn) {
    let v = sel.value;
    sel.innerHTML = '<option value="">Selecione</option>';
    arr.forEach(obj => sel.add(new Option(textFn(obj), valFn(obj))));
    sel.value = v;
  }
  setOptions(document.getElementById('clienteTarefa'), clientes, c=>c.razaoSocial, c=>c.razaoSocial);
  setOptions(document.getElementById('tecnicoTarefa'), tecnicos, t=>t.nome, t=>t.nome);
  let tipoArr = Object.keys(tiposDeTarefa);
  let tipoSel = document.getElementById('tipoTarefa');
  let tipoV = tipoSel.value;
  tipoSel.innerHTML = '<option value="">Selecione o Tipo de Tarefa</option>';
  tipoArr.forEach(t=>tipoSel.add(new Option(t,t)));
  tipoSel.value = tipoV;
  // Filtros
  setOptions(document.getElementById('filtroCliente'), clientes, c=>c.razaoSocial, c=>c.razaoSocial);
  setOptions(document.getElementById('filtroTecnico'), tecnicos, t=>t.nome, t=>t.nome);
  let fTipo = document.getElementById('filtroTipo');
  let vTipo = fTipo.value;
  fTipo.innerHTML = '<option value="">Todos</option>';
  tipoArr.forEach(t=>fTipo.add(new Option(t,t)));
  fTipo.value = vTipo;
}

function exportarJSON() {
  let dados = {clientes,tecnicos,tiposDeTarefa,tarefas};
  let blob = new Blob([JSON.stringify(dados,null,2)], {type:'application/json'});
  let link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'infraestrutura_backup.json';
  link.click();
}
function importarJSON(input) {
  if(!input.files||!input.files[0]) return;
  let reader = new FileReader();
  reader.onload = function(e) {
    try {
      let dados = JSON.parse(e.target.result);
      clientes = dados.clientes||[]; tecnicos = dados.tecnicos||[]; tiposDeTarefa = dados.tiposDeTarefa||{}; tarefas = dados.tarefas||[];
      salvarClientes(); salvarTecnicos(); salvarTipos(); salvarTarefas();
      renderClientes(); renderTecnicos(); renderTipos(); atualizarSelects(); renderTarefas();
      alert('Dados importados com sucesso!');
    } catch(err) { alert('Erro ao importar: '+err.message);}
    input.value='';
  };
  reader.readAsText(input.files[0]);
}

function exportarTarefasPDF() {
  mostrarSecao('tarefas');
  setTimeout(() => {
    let el = document.getElementById('tarefasContainer');
    let opt = {
      margin: 0.5,
      filename: 'relatorio_tarefas.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
    };
    html2pdf().set(opt).from(el).save();
  }, 300);
}

function limparFiltros() {
  document.getElementById('filtroCliente').value = "";
  document.getElementById('filtroTecnico').value = "";
  document.getElementById('filtroTipo').value = "";
  document.getElementById('filtroStatus').value = "";
  document.getElementById('filtroData').value = "";
  renderTarefas();
}

function mostrarSecao(secao) {
  document.querySelectorAll('.section').forEach(div => div.classList.add('hidden'));
  if(secao==='menu') return;
  document.getElementById(`secao-${secao}`).classList.remove('hidden');
}
window.onload = function() {
  carregarClientes(); renderClientes();
  carregarTecnicos(); renderTecnicos();
  carregarTipos(); renderTipos();
  carregarTarefas(); renderTarefas();
  atualizarSelects();
  mostrarSecao('menu');
};
</script>
</body>
</html>
