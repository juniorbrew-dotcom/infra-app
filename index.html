<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gestão de Infraestrutura</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background-color: #f4f4f4; }
    h1, h2 { text-align: center; }
    form, .section { background-color: #fff; padding: 20px; margin-bottom: 30px; border: 1px solid #ccc; }
    input, select, textarea { margin: 10px 0; padding: 8px; width: 100%; box-sizing: border-box; }
    button { padding: 10px 20px; background-color: #007BFF; color: white; border: none; cursor: pointer; margin: 5px; }
    table { width: 100%; border-collapse: collapse; background-color: #fff; margin-bottom: 40px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background-color: #007BFF; color: white; }
    .hidden { display: none; }
    .done { background-color: #d4edda !important; }
    .filter-bar { margin-bottom: 15px; background: #e3e8f0; padding: 12px; border-radius: 6px; }

    .expand-btn {
      font-size: 22px;
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      color: #007BFF;
      margin: 0 4px 0 0;
      padding: 0;
      width: 24px; height: 24px;
      line-height: 24px;
      display: inline-block;
      vertical-align: middle;
      text-align: center;
    }
    .action-btn {
      background: #2196f3;
      color: #fff;
      border: none;
      padding: 5px 16px;
      margin: 0 2px;
      font-size: 18px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      vertical-align: middle;
    }
    .action-btn:active, .action-btn:focus { background: #1565c0; }
    .action-btn.edit { background: #2196f3; }
    .action-btn.delete { background: #2196f3; }
    .action-btn.complete { background: #4caf50; }
    .action-btn.complete:disabled { background: #a5d6a7; color: #fff; cursor: not-allowed; }

    .checklist-row {
      background: #fafafa;
    }
    .checklist-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }
    .checklist-table td {
      border: none;
      padding: 3px 0;
      vertical-align: top;
    }
    .checklist-checkbox-col { width: 32px; }
    .checklist-label-col { font-weight: bold; color: #222; font-size: 15px; padding-left: 6px; }
  </style>
  <!-- ÍCONES DE AÇÃO (FontAwesome CDN opcional) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
  <h1>Gestão de Infraestrutura</h1>
  <div>
    <button onclick="mostrarSecao('clientes')">Clientes</button>
    <button onclick="mostrarSecao('tecnicos')">Técnicos</button>
    <button onclick="mostrarSecao('tipos')">Tipos de Tarefa</button>
    <button onclick="mostrarSecao('tarefas')">Tarefas</button>
  </div>

  <!-- ... (clientes, técnicos e tipos de tarefa: igual ao anterior) ... -->

  <!-- TAREFAS -->
  <div id="secao-tarefas" class="section hidden">
    <h2>Tarefas</h2>
    <button onclick="mostrarSecao('menu')">Menu</button>
    <form id="tarefaForm">
      <input type="text" id="tituloTarefa" placeholder="Título da Tarefa" required>
      <select id="clienteTarefa" required>
        <option value="">Selecione o Cliente</option>
      </select>
      <select id="tecnicoTarefa" required>
        <option value="">Selecione o Técnico</option>
      </select>
      <select id="tipoTarefa" required onchange="renderPreviewChecklist()">
        <option value="">Selecione o Tipo de Tarefa</option>
      </select>
      <input type="date" id="dataTarefa" required>
      <div id="preview-checklist" class="hidden">
        <b>Checklist:</b>
        <ul id="previewChecklistList"></ul>
      </div>
      <button type="submit">Adicionar Tarefa</button>
    </form>
    <div class="filter-bar">
      <label>Cliente:</label>
      <select id="filtroCliente" onchange="renderTarefas()"><option value="">Todos</option></select>
      <label>Técnico:</label>
      <select id="filtroTecnico" onchange="renderTarefas()"><option value="">Todos</option></select>
      <label>Tipo:</label>
      <select id="filtroTipo" onchange="renderTarefas()"><option value="">Todos</option></select>
      <label>Status:</label>
      <select id="filtroStatus" onchange="renderTarefas()"><option value="">Todos</option><option value="pendente">Pendente</option><option value="concluida">Concluída</option></select>
      <label>Data:</label>
      <input type="date" id="filtroData" onchange="renderTarefas()">
      <button onclick="limparFiltros();return false;">Limpar Filtros</button>
    </div>
    <button onclick="exportarTarefasPDF()">Exportar PDF</button>
    <button onclick="exportarJSON()">Exportar JSON</button>
    <input type="file" id="importarJSONinput" style="display:none" accept=".json" onchange="importarJSON(this)">
    <button onclick="document.getElementById('importarJSONinput').click()">Importar JSON</button>
    <div id="tarefasContainer">
      <table id="tabelaTarefas">
        <thead>
          <tr>
            <th style="width:32px"></th>
            <th>Título</th>
            <th>Cliente</th>
            <th>Técnico</th>
            <th>Tipo</th>
            <th>Data</th>
            <th>Status</th>
            <th style="width:132px">Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
let clientes = [], tecnicos = [], tiposDeTarefa = {}, tarefas = [];
let expandedTarefa = {}; // indica se a tarefa está expandida

// ... (funções de clientes, técnicos e tipos: igual ao anterior) ...

function renderTarefas() {
  let tbody = document.getElementById('tabelaTarefas').getElementsByTagName('tbody')[0];
  tbody.innerHTML = '';
  let fc = document.getElementById('filtroCliente').value;
  let ft = document.getElementById('filtroTecnico').value;
  let ftip = document.getElementById('filtroTipo').value;
  let fs = document.getElementById('filtroStatus').value;
  let fd = document.getElementById('filtroData').value;
  tarefas.forEach((tar, i) => {
    if(fc && tar.cliente!==fc) return;
    if(ft && tar.tecnico!==ft) return;
    if(ftip && tar.tipo!==ftip) return;
    if(fs && ((fs==='pendente' && tar.status!=='pendente')||(fs==='concluida'&&tar.status!=='concluida'))) return;
    if(fd && tar.data!==fd) return;

    // Linha principal da tarefa
    let row = tbody.insertRow();
    if(tar.status==="concluida") row.classList.add('done');

    // Botão expandir/recolher
    let expandCell = row.insertCell(0);
    let expandBtn = document.createElement('button');
    expandBtn.type = "button";
    expandBtn.className = "expand-btn";
    expandBtn.innerHTML = expandedTarefa[i] ? '<span style="font-size:22px">&minus;</span>' : '<span style="font-size:22px">+</span>';
    expandBtn.title = expandedTarefa[i] ? "Recolher checklist" : "Expandir checklist";
    expandBtn.onclick = function() { expandedTarefa[i] = !expandedTarefa[i]; renderTarefas(); };
    expandCell.appendChild(expandBtn);

    row.insertCell(1).innerText = tar.titulo;
    row.insertCell(2).innerText = tar.cliente;
    row.insertCell(3).innerText = tar.tecnico;
    row.insertCell(4).innerText = tar.tipo;
    row.insertCell(5).innerText = tar.data;
    row.insertCell(6).innerText = tar.status==="concluida"?"Pendente":"Pendente";
    // Ações (botões azuis)
    let acoes = row.insertCell(7);
    let concluir = document.createElement('button');
    concluir.className = "action-btn complete";
    concluir.innerHTML = '<i class="fa fa-check"></i>';
    concluir.disabled = tar.status==="concluida";
    concluir.onclick = () => { tar.checklist.forEach(x=>x.feito=true); tar.status="concluida"; salvarTarefas(); renderTarefas(); };
    let editar = document.createElement('button');
    editar.className = "action-btn edit";
    editar.innerHTML = '<i class="fa fa-pen"></i>';
    editar.onclick = () => editarTarefa(i);
    let excluir = document.createElement('button');
    excluir.className = "action-btn delete";
    excluir.innerHTML = '<i class="fa fa-trash"></i>';
    excluir.onclick = () => { tarefas.splice(i,1); delete expandedTarefa[i]; salvarTarefas(); renderTarefas(); };
    acoes.appendChild(concluir); acoes.appendChild(editar); acoes.appendChild(excluir);

    // Checklist expandido: linha abaixo, 1 célula só
    if(expandedTarefa[i]) {
      let clrow = tbody.insertRow();
      clrow.className = "checklist-row";
      let cell = clrow.insertCell(0);
      cell.colSpan = 8;
      let checklistTable = document.createElement('table');
      checklistTable.className = 'checklist-table';
      tar.checklist.forEach((item, idx) => {
        let tr = checklistTable.insertRow();
        let tdChk = tr.insertCell(0);
        tdChk.className = 'checklist-checkbox-col';
        let chk = document.createElement('input');
        chk.type = "checkbox";
        chk.className = "checklist-checkbox";
        chk.checked = item.feito;
        chk.onchange = function() {
          tar.checklist[idx].feito = this.checked;
          tar.status = tar.checklist.every(x=>x.feito) ? "concluida" : "pendente";
          salvarTarefas(); renderTarefas();
        };
        tdChk.appendChild(chk);
        let tdLabel = tr.insertCell(1);
        tdLabel.className = 'checklist-label-col';
        tdLabel.innerText = item.texto;
      });
      cell.appendChild(checklistTable);
    }
  });
}
// ...restante do JS igual ao anterior...
// (clientes, técnicos, tipos, exportação, importação, filtros, navegação etc)

</script>
</body>
</html>
